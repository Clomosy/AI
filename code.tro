var
  MainForm : TclForm;
  QuestionEdit : TclProEdit;
  SendButton : TClProButton;
  ChatPnl,MsjPnl:TclProPanel;
  MsgList:TclMemo;
  MainLyt : TClLayout;
  MainTitleLbl:TclLabel;
  MyMQTT : TclMQTT;
  strIncomingData : String;
  Rest: TclRest;
  API_KEY: string;
  RequestBody: string;

void ACompletedProc;
{
  strIncomingData = Clomosy.CLParseJSON(Rest.Response,'candidates.0.content.parts.0.text');
  MsgList.Lines.Add(strIncomingData);
  MyMQTT.Send(strIncomingData);
}

void RestCreate(ABaseUrl, ABody :String);
{
  Rest = TclRest.Create;
  Rest.Accept = 'application/json';
  Rest.ContentType = 'application/json'; // Content-Type
  Rest.Method = rmPOST;
  Rest.ConnectTimeOut = 30000;
  Rest.BaseURL = ABaseUrl; //'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + API_KEY
  Rest.Body = ABody;
  Rest.OnCompleted = 'ACompletedProc';
  Rest.ExecuteAsync;
  
}

void BtnSendClick;
{
 if ((Clomosy.AppUserProfile==1) && (QuestionEdit.Text <> '')) 
 {
  if QuestionEdit.Text <> ''
  {
    MyMQTT.Send(QuestionEdit.Text);
    MsgList.Lines.Add(QuestionEdit.Text);
    MsgList.ScrollTo(0,MsgList.Lines.Count*MsgList.Lines.Count,True);
  
    API_KEY = 'YourAPIKey';  //  Kendi API anahtarınızı buraya girin.
      // Gönderilecek JSON verilerini oluşturun
      RequestBody = '{
      "contents": [
        {
          "parts": [
            {
              "text": "'+QuestionEdit.Text+'"
            }
          ]
        }
      ]
    }';
    RestCreate('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + API_KEY,RequestBody);
    QuestionEdit.Text = '';
  } else
  {
    ShowMessage('Lütfen bir soru sorun!');
  }
 }
}

void MyMQTTPublishReceived;
{
  if (MyMQTT.ReceivedAlright ) 
  {
    if (Clomosy.AppUserProfile <> 1 )
    {
      MsgList.Lines.Add('');
      MsgList.Lines.Add(MyMQTT.ReceivedMessage);
      MsgList.ScrollTo(0,MsgList.Lines.Count*MsgList.Lines.Count,True);
    }
  }
}

void SetMiddlePanel;
{
  MsjPnl=MainForm.AddNewProPanel(MainLyt,'MsjPnl');
  MsjPnl.Align = AlBottom;
  MsjPnl.Height = 100;
  MsjPnl.Margins.Top = 5;
  MsjPnl.Margins.Bottom = 20;
  MsjPnl.Margins.Left = 10;
  MsjPnl.Margins.Right = 10;
  MsjPnl.SetclProSettings(ChatPnl.clProSettings);
  
  QuestionEdit = MainForm.AddNewProEdit(MsjPnl,'QuestionEdit','Bir soru sor...');
  QuestionEdit.Align = AlClient;
  QuestionEdit.Margins.Left = 10;
  QuestionEdit.Margins.Right = 10;
  QuestionEdit.Margins.Top = 10;
  QuestionEdit.Margins.Bottom = 10;
  QuestionEdit.clProSettings.BorderColor = clAlphaColor.clHexToColor('#3bf5c0');
  QuestionEdit.clProSettings.FontHorzAlign = palLeading;
  QuestionEdit.clProSettings.BorderWidth = 1;
  QuestionEdit.clProSettings.IsRound = True;
  QuestionEdit.clProSettings.RoundHeight = 10;
  QuestionEdit.clProSettings.RoundWidth = 10;
  QuestionEdit.clProSettings.WordWrap = True;
  QuestionEdit.SetclProSettings(QuestionEdit.clProSettings);
  
  SendButton = MainForm.AddNewProButton(MsjPnl,'SendButton','Gönder');
  SendButton.Align = AlRight;
  SendButton.Width = MsjPnl.Width/4;
  SendButton.Margins.Bottom = 10;
  SendButton.Margins.Top = 10;
  SendButton.Margins.Right = 10;
  SendButton.clProSettings.BackgroundColor = clAlphaColor.clHexToColor('#1814F3');
  SendButton.clProSettings.FontColor = clAlphaColor.clHexToColor('#ffffff');
  SendButton.clProSettings.FontSize = 16;
  SendButton.clProSettings.TextSettings.Font.Style = [fsBold];
  SendButton.clProSettings.IsRound = True;
  SendButton.clProSettings.RoundHeight = 10;
  SendButton.clProSettings.RoundWidth = 10;
  SendButton.SetclProSettings(SendButton.clProSettings);
  
  MainForm.AddNewEvent(SendButton,tbeOnClick,'BtnSendClick');
}

void SetBigPanel;
{
  ChatPnl=MainForm.AddNewProPanel(MainLyt,'ChatPnl');
  ChatPnl.Align = AlClient;
  ChatPnl.Margins.Right = 10;
  ChatPnl.Margins.Left = 10;
  ChatPnl.Margins.Right = 10;
  ChatPnl.Margins.Right = 10;
  ChatPnl.clProSettings.BorderColor = clAlphaColor.clHexToColor('#008000');
  ChatPnl.clProSettings.BorderWidth = 0;
  ChatPnl.clProSettings.IsRound = True;
  ChatPnl.clProSettings.RoundHeight = 5;
  ChatPnl.clProSettings.RoundWidth = 5;
  ChatPnl.clProSettings.BackgroundColor = clAlphaColor.clHexToColor('#f7f7f7');
  ChatPnl.SetclProSettings(ChatPnl.clProSettings);
  
  MsgList= MainForm.AddNewMemo(ChatPnl,'MsgList','');
  MsgList.Align = alClient;
  MsgList.ReadOnly = True;
  MsgList.Margins.Top= 20;
  MsgList.Margins.Left= 20;
  MsgList.Margins.Bottom= 20;
  MsgList.Margins.Right =20;
  MsgList.TextSettings.Font.Size=26;
  MsgList.TextSettings.WordWrap = True;
  MsgList.EnabledScroll = True;  //olmadi telefonda görünmüyor
}

void SetMainTitle;
{
  MainTitleLbl= MainForm.AddNewLabel(MainForm.LytTopBar,'MainTitleLbl',' Clomosy Yapay Zeka');
  MainTitleLbl.StyledSettings = ssFamily;
  MainTitleLbl.TextSettings.Font.Size=20;
  MainTitleLbl.Align = alLeft;
  MainTitleLbl.Margins.Left= 14;
  MainTitleLbl.Margins.Top= 10; 
  MainTitleLbl.Height = 65;
  MainTitleLbl.Width = 259;
}
 
void VirtualKeyboardShow;
{
  MsjPnl.Margins.Bottom = MainForm.clVKBoundsHeight;
}

void VirtualKeyboardHidden;
{
  MsjPnl.Margins.Bottom = 0;
}

{
  MainForm = TclForm.Create(Self);
  MainForm.BtnFormMenu.Visible = False;
  MainForm.FormWaiting.Visible = False;
  Clomosy.ShowExceptions = False;
  
  SetMainTitle;
  
  MainLyt = MainForm.AddNewLayout(MainForm,'MainLyt');
  MainLyt.Align=alClient;
  MainLyt.Margins.Bottom = 10;
  MainLyt.Margins.Top = 10;
  
  SetBigPanel;
  SetMiddlePanel;

  MyMQTT = MainForm.AddNewMQTTConnection(MainForm,'MyMQTT');
  MainForm.AddNewEvent(MyMQTT,tbeOnMQTTPublishReceived,'MyMQTTPublishReceived');
  MyMQTT.Channel = 'ChatAI';
  MyMQTT.Connect;
  
  
  if (Clomosy.AppUserProfile == 1 )
  {
    SendButton.Enabled = True;
  }
  else
  {
    SendButton.Enabled = False;
    QuestionEdit.Text = 'Yalnızca yönetici yazabilir.';
    QuestionEdit.Enabled = False;
  }

    MainForm.Run;
}
